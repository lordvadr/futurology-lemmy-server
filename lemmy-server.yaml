AWSTemplateFormatVersion: 2010-09-09
Description: Cloudformation build for /r/Futurology's Lemmy instance
Parameters:
  SSHKey:
    Description: 'The EC2 Key Pair to allow SSH access to the nodes'
    Type: 'AWS::EC2::KeyPair::KeyName'
  NumberOfAZs:
    Description: 'Number of availability zones to deploy into. Valid values are 1 and 3.'
    Default: 3
    Type: Number
    AllowedValues:
      - 1
      - 3
  StackName:
    Description: 'Name of the cloudformation stack'
    Type: String
Mappings:
  VPCMap:
    us-west-2:
      vpc: vpc-2f6ff94a
  AmiMap:
    us-west-2:
      #serverami: ami-04e914639d0cca79a # amazon linux
      #serverami: ami-0672af4b5c29cece0 # rocky 9
      serverami: ami-0dda7e535b65b6469 # rhel 9
  AZMap:
    us-west-2:
      zone1: us-west-2a
      zone2: us-west-2b
      zone3: us-west-2c
  SubnetMap:
    us-west-2:
      zone1: subnet-2f0f614a
      zone2: subnet-8f911df8
      zone3: subnet-5047e709
Resources:
  serversg:
    Type: 'AWS::EC2::SecurityGroup' 
    Properties: 
      VpcId: !FindInMap [ VPCMap, !Ref 'AWS::Region', vpc ]
      GroupDescription: Permit Any IPv4
      GroupName: cloud-server-permit-any
      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        IpProtocol: -1
      - CidrIpv6: ::0/0
        IpProtocol: -1
      SecurityGroupEgress:
      - CidrIp: 0.0.0.0/0
        IpProtocol: -1
      - CidrIpv6: ::0/0
        IpProtocol: -1
  server:
    Type: AWS::EC2::Instance 
    Properties:
      ImageId: !FindInMap [ AmiMap, !Ref 'AWS::Region', serverami ]
      InstanceType: t3.small
      KeyName: !Ref SSHKey
      SecurityGroupIds: [ { "Fn::GetAtt" : [ "serversg", "GroupId" ] } ]
      Tags:
      - Key: Name
        Value: !Ref StackName
      UserData: IyEvdXNyL2Jpbi9lbnYgYmFzaAoKc2V0IC1ldW8gcGlwZWZhaWwKCmtleXM9KCIyNUEzMzQzMUQwQzg2N0NGNjkxOTlFMjRCMUQ4MzI1NDY4MzQ0RDVGIikKY29uZmlnPSJodHRwczovL2dpdGh1Yi5jb20vbG9yZHZhZHIvbGVtbXktc2VydmVyLWNvbmZpZy5naXQiCmJyYW5jaD0ibWFpbiIKd29ya2Rpcj0ic2VydmVyLWNvbmZpZyIKCmRpZSgpIHsKCT4mMiBlY2hvICJGQVRBTDogJHtAOi1VTktOT1dOIEVSUk9SfSIKCWV4aXQgMQp9CgpjbGVhbnVwKCkgewoJbG9jYWwgcnY9IiR7P30iCglbICIke3J2fSIgPT0gIjAiIF0gfHwgeyA+JjIgZWNobyAiRkFUQUwgRkFUQUwgRkFUQUwgRkFUQUwgISEhISEhIFNDUklQVCBESUQgTk9UIEVYSVQgQ0xFQU5MWSI7IH0KfQoKdHJ1c3RrZXkoKSB7CglncGcgLS1rZXlzZXJ2ZXIga2V5cy5vcGVucGdwLm9yZyAtLXJlY3Yta2V5cyAiJHsxfSIgJiYgZWNobyAiJHsxfTo2OiIgfCBncGcgLS1pbXBvcnQtb3duZXJ0cnVzdAp9Cgp0cmFwIGNsZWFudXAgRVhJVAoKY2QgL3Jvb3QgfHwgZGllICJDb3VsZCBub3QgY2hhbmdlIHdvcmtpbmcgZGlyZWN0b3J5IHRvIC9yb290IgoKc3VkbyBkbmYgLXkgLS1hbGxvd2VyYXNpbmcgaW5zdGFsbCBkaXJtbmdyIGdpdCB8fCBkaWUgIkNvdWxkIG5vdCBpbnN0YWxsIGdpdCBhbmQgb3RoZXIgdG9vbHMuIgoKZm9yIGtleSBpbiAiJHtrZXlzW0BdfSI7IGRvCgl0cnVzdGtleSAiJHtrZXl9IiB8fCBkaWUgIkNvdWxkIG5vdCBpbXBvcnQga2V5L3NldCB0cnVzdCBmb3Iga2V5aWQgXCIke2tleX1cIi4iCmRvbmUKClsgISAtZCAiJHt3b3JrZGlyfSIgXSAmJiBbICEgLWUgIiR7d29ya2Rpcn0iIF0gfHwgcm0gLXJmICIke3dvcmtkaXJ9IiB8fCBkaWUgIkNvdWxkIG5vdCByZW1vdmUgc3RhbGUgd29ya2RpciBcIiR7d29ya2Rpcn1cIi4iCgpnaXQgY2xvbmUgIiR7Y29uZmlnfSIgIiR7d29ya2Rpcn0iIHx8IGRpZSAiQ291bGQgbm90IGNsb25lIGNvbmZpZ3VyYXRpb24gcmVwb3NpdG9yeS4iCgpwdXNoZCAiJHt3b3JrZGlyfSIgfHwgZGllICJDb3VsZCBub3QgY2QgaW50byB3b3JraW5nIGRpcmVjdG9yeSBcIiR7d29ya2Rpcn1cIi4iCgpnaXQgY2hlY2tvdXQgIiR7YnJhbmNofSIgfHwgZGllICJDb3VsZCBub3QgY2hlY2tvdXQgXCIke2JyYW5jaH1cIiBicmFuY2guIgoKQ09NTUlUPSIiCgpmb3IgYyBpbiAkKGdpdCBsb2cgLS1wcmV0dHk9Zm9ybWF0OiIlSCIpOyBkbwoJaWYgZ2l0IHZlcmlmeS1jb21taXQgIiR7Y30iOyB0aGVuCgkJQ09NTUlUPSIke2N9IgoJCWdpdCBjaGVja291dCAiJHtjfSIKCQlicmVhawoJZWxzZQoJCUNPTU1JVD0iIgoJZmkKZG9uZQoKWyAtbiAiJHtDT01NSVR9IiBdIHx8IGRpZSAiTm8gc2lnbmVkIGNvbW1pdCBmb3VuZC4iCgplY2hvICJNb3N0IHJlY2VudCBzaWduZWQgY29tbWl0IGlzIFwiJHtDT01NSVR9XCIuIgoKWyAtZSAic2V0dXAuc2giIF0gfHwgZGllICJObyBcInNldHVwLnNoXCIgc2NyaXB0IHRvIGxhdW5jaC4iCgpbIC14ICJzZXR1cC5zaCIgXSB8fCBkaWUgIlwic2V0dXAuc2hcIiBpcyBub3QgZXhlY3V0YWJlbC4iCgpiYXNoIC1uICJzZXR1cC5zaCIgfHwgZGllICJcInNldHVwLnNoXCIgZG9lcyBub3QgcGFzcyBsaW50aW5nIGJ5IGJhc2guIgoKZXhlYyAuL3NldHVwLnNoCg==
  lemmyEIP:
    Type: AWS::EC2::EIP
    Properties:
      InstanceId: !Ref server
